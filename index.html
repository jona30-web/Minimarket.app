<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Distribuidora Chacha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 40; display: none; }
        .overlay.active { display: block; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); z-index: 50; display: none; max-width: 90%; width: 500px; max-height: 90%; overflow-y: auto; }
        .modal.active { display: block; }
        .product-card { display: flex; flex-direction: column; justify-content: space-between; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid #eee; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        #sidebar nav a.active { background-color: #e0e7ff; color: #4f46e5; font-weight: 600; }
        .max-h-96-overflow { max-height: 24rem; overflow-y: auto; }
        .max-h-48-overflow { max-height: 12rem; overflow-y: auto; }

        /* Estilos para los botones de Acciones Rápidas */
        .quick-action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem; /* Aumenta el padding para hacerlos más grandes */
            background-color: white;
            border-radius: 0.75rem; /* Bordes más redondeados */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); /* Sombra suave */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            color: #4b5563; /* Color de texto más oscuro */
        }
        .quick-action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .quick-action-button .icon-circle {
            width: 56px; /* Tamaño del círculo de ícono */
            height: 56px; /* Tamaño del círculo de ícono */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem; /* Espacio entre el círculo y el texto */
            font-size: 1.75rem; /* Tamaño del ícono */
            color: white;
        }
        /* Colores de ejemplo para los círculos de íconos */
        .icon-circle.blue { background-color: #3b82f6; } /* Nueva Venta */
        .icon-circle.purple { background-color: #8b5cf6; } /* Agregar Producto */
        .icon-circle.pink { background-color: #ec4899; } /* Nuevo Cliente */
        .icon-circle.orange { background-color: #f97316; } /* Generar Reporte */
        .icon-circle.indigo { background-color: #6366f1; } /* Gestionar Inventario */
        .icon-circle.red { background-color: #ef4444; } /* Horarios (Placeholder) */

        /* Estilos para el escáner de código de barras */
        #barcode-scanner-container {
            width: 100%;
            height: 200px; /* Ajusta la altura según sea necesario */
            background-color: #333;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
        }
        #barcode-scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        #barcode-scanner-container .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; /* Ancho del área de escaneo */
            height: 60%; /* Alto del área de escaneo */
            border: 2px solid #4CAF50; /* Color del borde del área de escaneo */
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.6); /* Oscurece el exterior */
            pointer-events: none; /* Permite hacer clic a través del div */
            z-index: 10;
        }

        /* Estilos para la impresión del recibo */
        /* Oculta todo excepto el recibo cuando se imprime */
        @media print {
            body > *:not(#receipt-print-area) {
                display: none !important;
            }
            body {
                margin: 0;
                padding: 0;
                /* Puedes ajustar el ancho para impresoras térmicas (ej. 58mm ~ 2.28in, 80mm ~ 3.15in) */
                width: 58mm; /* Ancho típico para recibos pequeños, ajusta según tu impresora */
                font-family: 'monospace', 'Courier New', Courier, monospace; /* Fuente monoespaciada */
                font-size: 9px; /* Tamaño de fuente pequeño para recibos */
                color: black;
            }
            #receipt-print-area {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none; /* Elimina sombras del modal */
                padding: 0;
                margin: 0;
            }
            /* Oculta el botón de cerrar y el botón de imprimir dentro del modal de impresión */
            #receipt-print-area .no-print {
                display: none !important;
            }
            /* Asegúrate de que los bordes y padding se manejen bien en la impresión */
            #receipt-print-area .receipt-item {
                border-bottom: 1px dashed #ccc;
                padding: 2px 0;
                margin-bottom: 2px;
            }
            #receipt-print-area .receipt-total {
                border-top: 1px dashed #ccc;
                padding-top: 4px;
                margin-top: 4px;
            }
            h4, h5 { margin: 2px 0; padding: 0; }
            p { margin: 1px 0; padding: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex">

    <div id="overlay" class="overlay lg:hidden"></div>

    <aside id="sidebar" class="w-64 h-full bg-white shadow-lg fixed top-0 left-0 z-50 transform -translate-x-full lg:translate-x-0 transition-transform">
        <div class="p-4 border-b">
            <h3 class="text-xl font-semibold">Distribuidora Chacha</h3>
            <p class="text-sm text-gray-500">Sistema de Gestión</p>
        </div>
        <nav class="p-4">
            <ul class="space-y-1">
                <li><a href="#dashboard-section" class="flex items-center p-3 rounded-lg font-medium" data-section="dashboard"><i class="fas fa-tachometer-alt w-6 mr-3"></i>Dashboard</a></li>
                <li><a href="#nueva-venta-section" class="flex items-center p-3 rounded-lg font-medium" data-section="nueva-venta"><i class="fas fa-cash-register w-6 mr-3"></i>Nueva Venta</a></li>
                <li><a href="#ventas-section" class="flex items-center p-3 rounded-lg font-medium" data-section="ventas"><i class="fas fa-chart-line w-6 mr-3"></i>Historial Ventas</a></li>
                <li><a href="#cuentas-section" class="flex items-center p-3 rounded-lg font-medium" data-section="cuentas"><i class="fas fa-file-invoice-dollar w-6 mr-3"></i>Cuentas por Cobrar</a></li>
                <li><a href="#almacen-section" class="flex items-center p-3 rounded-lg font-medium" data-section="almacen"><i class="fas fa-warehouse w-6 mr-3"></i>Almacén</a></li>
                <li><a href="#clientes-section" class="flex items-center p-3 rounded-lg font-medium" data-section="clientes"><i class="fas fa-user-friends w-6 mr-3"></i>Clientes</a></li>
                <li><a href="#empleados-section" class="flex items-center p-3 rounded-lg font-medium" data-section="empleados"><i class="fas fa-users-cog w-6 mr-3"></i>Empleados</a></li>
                <li><a href="#reportes-section" class="flex items-center p-3 rounded-lg font-medium" data-section="reportes"><i class="fas fa-chart-pie w-6 mr-3"></i>Reportes</a></li>
                <li><a href="#configuracion-negocio-section" class="flex items-center p-3 rounded-lg font-medium" data-section="configuracion-negocio"><i class="fas fa-cog w-6 mr-3"></i>Configuración Negocio</a></li>
            </ul>
        </nav>
    </aside>

    <div class="flex-1 flex flex-col lg:ml-64">
        <header class="flex items-center justify-between px-4 py-3 border-b bg-white shadow-sm sticky top-0 z-30">
            <div class="flex items-center"><button id="menu-toggle" class="text-xl lg:hidden mr-3"><i class="fas fa-bars"></i></button><h1 id="main-header-title" class="font-semibold text-xl"></h1></div>
            <div class="flex items-center space-x-2"><div class="bg-blue-600 rounded-full w-8 h-8 flex items-center justify-center text-white"><i class="fas fa-user"></i></div><span>Admin</span></div>
        </header>

        <main id="content-area" class="p-4 lg:p-6 flex-1 overflow-y-auto">
            </main>
    </div>

    <div id="modal-container"></div>

<script type="module">
    // --- FASE 1: CONEXIÓN A FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, addDoc, deleteDoc, updateDoc, setDoc, writeBatch, serverTimestamp, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    // Importación de QuaggaJS para el escáner de código de barras
    // QuaggaJS no es un módulo ES6, se carga globalmente o a través de un script tag separado.
    // Para simplificar, asumiremos que QuaggaJS está disponible globalmente si se carga con un <script> antes de este.
    // Si no, necesitaríamos un wrapper o import dinámico. Para esta demostración, no lo importamos directamente aquí.

    // Tu configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDq6SsrhCeXDjKQ1SPEnVTTXvSY_RO5Zqc",
      authDomain: "distribuidora-chacha.firebaseapp.com",
      projectId: "distribuidora-chacha",
      storageBucket: "distribuidora-chacha.appspot.com",
      messagingSenderId: "852885176903",
      appId: "1:852885176903:web:f2b3d048e832e90dece762"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- FASE 2: ESTADO GLOBAL Y DOM ---
    const state = {
        productos: [],
        clientes: [],
        empleados: [],
        ventas: [],
        cuentas_por_cobrar: [],
        cart: [],
        searchTerm: '', // Para la búsqueda de productos
        amountReceived: 0, // Nuevo estado para el monto recibido
        isScannerActive: false, // Estado para controlar el escáner
        // NUEVA FUNCIONALIDAD: Estado para los datos del negocio
        businessInfo: {
            nombre: "Distribuidora Chacha",
            direccion: "Tu Dirección, Ciudad, País",
            telefono: "123-456-7890",
            ruc: "0000000000001" // RUC o Identificación fiscal
        }
    };
    // const IVA_RATE = 0.15; // Eliminado o comentado, ya que no se usará el IVA
    const DOMElements = {
        sidebar: document.getElementById('sidebar'),
        menuToggle: document.getElementById('menu-toggle'),
        overlay: document.getElementById('overlay'),
        mainHeaderTitle: document.getElementById('main-header-title'),
        sidebarLinks: document.querySelectorAll('#sidebar nav a'),
        contentArea: document.getElementById('content-area'),
        modalContainer: document.getElementById('modal-container')
    };

    // --- FASE 3: LÓGICA DE UI Y NAVEGACIÓN ---
    window.hideModal = () => {
        const modal = DOMElements.modalContainer.querySelector('.modal');
        if(modal) modal.classList.remove('active');
        DOMElements.overlay.classList.remove('active');
        // Detener el escáner si está activo al cerrar el modal
        if (state.isScannerActive) {
            stopScanner();
        }
        setTimeout(() => { DOMElements.modalContainer.innerHTML = ''; }, 200);
    };

    window.showModal = (contentHtml) => {
        // Asegúrate de que el overlay esté activo para que pueda cerrarse al hacer clic
        DOMElements.modalContainer.innerHTML = `
            <div class="modal active">
                ${contentHtml}
                <div class="mt-6 text-right no-print">
                    <button onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
                </div>
            </div>
        `;
        DOMElements.overlay.classList.add('active');
    };

    window.showSection = async (sectionId) => {
        const link = document.querySelector(`a[data-section="${sectionId.replace('-section', '')}"]`);
        if (link) {
            DOMElements.mainHeaderTitle.textContent = link.textContent.trim();
            DOMElements.sidebarLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
        }
        if (window.innerWidth < 1024) { DOMElements.sidebar.classList.add('-translate-x-full'); DOMElements.overlay.classList.remove('active'); }

        // Detener el escáner si está activo al cambiar de sección
        if (state.isScannerActive) {
            stopScanner();
        }

        // Mostrar un mensaje de carga mientras se obtienen los datos
        DOMElements.contentArea.innerHTML = '<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-4 text-gray-600">Cargando...</p></div>';

        // Recargar datos siempre que cambiamos de sección para tenerlos actualizados
        await fetchData('productos');
        await fetchData('clientes');
        await fetchData('empleados');
        await fetchData('ventas');
        await fetchData('cuentas_por_cobrar');
        // NUEVA FUNCIONALIDAD: Cargar información del negocio
        await fetchBusinessInfo();

        // Renderizar la sección específica
        switch (sectionId) {
            case 'dashboard-section':
                renderDashboard();
                break;
            case 'nueva-venta-section':
                // Solo renderiza la estructura de Nueva Venta una vez
                renderNuevaVentaStructure();
                // Luego, renderiza los productos filtrados
                renderFilteredProducts();
                break;
            case 'ventas-section':
                renderVentas();
                break;
            case 'cuentas-section':
                renderCuentasPorCobrar();
                break;
            case 'almacen-section':
                renderAlmacen();
                break;
            case 'clientes-section':
                renderClientes();
                break;
            case 'empleados-section':
                renderEmpleados();
                break;
            case 'reportes-section':
                renderReportes();
                break;
            // NUEVA FUNCIONALIDAD: Caso para la sección de configuración de negocio
            case 'configuracion-negocio-section':
                renderConfiguracionNegocio();
                break;
            // Manejo de acciones rápidas que no corresponden a una sección directamente
            case 'add-product':
                showProductForm();
                break;
            case 'add-customer':
                showCustomerForm();
                break;
            // Para "Horarios" no hay una sección directa, podrías añadir un modal simple o un alert
            case 'horarios':
                alert('La gestión de horarios no está implementada aún.');
                renderDashboard(); // Vuelve al dashboard si no hay una sección para esto
                break;
            default:
                DOMElements.contentArea.innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-bold text-gray-700 mb-4">Sección no encontrada</h2><p class="mt-2 text-gray-500">Por favor, selecciona una sección válida del menú.</p></div>`;
        }
    };

    const fetchData = async (collectionName) => {
        try {
            const q = query(collection(db, collectionName));
            const querySnapshot = await getDocs(q);
            state[collectionName] = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            console.log(`Datos de ${collectionName} cargados:`, state[collectionName]);
        } catch (error) {
            console.error(`Error al leer ${collectionName} desde Firebase:`, error);
            state[collectionName] = [];
        }
    };

    // NUEVA FUNCIONALIDAD: Cargar información del negocio
    const fetchBusinessInfo = async () => {
        try {
            const docRef = doc(db, "configuracion", "negocio"); // Usaremos un documento fijo para la configuración del negocio
            const docSnap = await getDocs(docRef);
            if (docSnap.exists()) {
                state.businessInfo = { ...docSnap.data() };
                console.log("Información del negocio cargada:", state.businessInfo);
            } else {
                console.log("No se encontró información del negocio en Firebase. Usando valores por defecto.");
                // Si no existe, podemos crearla o simplemente usar los valores por defecto del estado.
                // Para el inicio, los valores por defecto son suficientes.
            }
        } catch (error) {
            console.error("Error al cargar la información del negocio:", error);
        }
    };

    // --- FASE 4: FUNCIONES DE RENDERIZADO ---

    function renderDashboard() {
        const totalProducts = state.productos.length;
        const totalSales = state.ventas.length;
        const totalRevenue = state.ventas.reduce((sum, venta) => sum + (venta.total || 0), 0).toFixed(2);
        const pendingAccounts = state.cuentas_por_cobrar.filter(c => c.estado === 'Pendiente').length;
        const topProducts = [...state.productos].sort((a, b) => b.stock - a.stock).slice(0, 5);
        const recentSales = [...state.ventas].sort((a, b) => (b.fecha?.toDate() || 0) - (a.fecha?.toDate() || 0)).slice(0, 5);

        let topProductsHtml = topProducts.length > 0 ? topProducts.map(p => `
            <li class="flex justify-between items-center py-2 border-b last:border-b-0">
                <span>${p.name}</span>
                <span class="bg-gray-200 text-gray-800 px-2 py-1 rounded-full text-sm">${p.stock} unidades</span>
            </li>
        `).join('') : '<p class="text-gray-500 text-sm">No hay productos para mostrar.</p>';

        let recentSalesHtml = recentSales.length > 0 ? recentSales.map(s => `
            <li class="flex justify-between items-center py-2 border-b last:border-b-0">
                <span>Venta a ${s.clienteNombre || 'Cliente General'}</span>
                <span class="font-semibold text-blue-600">$${s.total ? s.total.toFixed(2) : '0.00'}</span>
            </li>
        `).join('') : '<p class="text-gray-500 text-sm">No hay ventas recientes.</p>';


        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Dashboard General</h2>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-semibold border-b pb-3 mb-5">Acciones Rápidas</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-6">
                    <button class="quick-action-button" onclick="showSection('nueva-venta-section')">
                        <div class="icon-circle blue"><i class="fas fa-plus"></i></div>
                        Nueva Venta
                    </button>
                    <button class="quick-action-button" onclick="showSection('add-product')">
                        <div class="icon-circle purple"><i class="fas fa-box"></i></div>
                        Agregar Producto
                    </button>
                    <button class="quick-action-button" onclick="showSection('add-customer')">
                        <div class="icon-circle pink"><i class="fas fa-user-plus"></i></div>
                        Nuevo Cliente
                    </button>
                    <button class="quick-action-button" onclick="showSection('reportes-section')">
                        <div class="icon-circle orange"><i class="fas fa-chart-pie"></i></div>
                        Generar Reporte
                    </button>
                    <button class="quick-action-button" onclick="showSection('almacen-section')">
                        <div class="icon-circle indigo"><i class="fas fa-warehouse"></i></div>
                        Gestionar Inventario
                    </button>
                    <button class="quick-action-button" onclick="showSection('horarios')">
                        <div class="icon-circle red"><i class="fas fa-calendar-alt"></i></div>
                        Horarios
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Productos Registrados</p>
                        <h3 class="text-3xl font-bold text-blue-600">${totalProducts}</h3>
                    </div>
                    <i class="fas fa-box text-blue-400 text-4xl"></i>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Total de Ventas</p>
                        <h3 class="text-3xl font-bold text-green-600">${totalSales}</h3>
                    </div>
                    <i class="fas fa-shopping-cart text-green-400 text-4xl"></i>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Ingresos Totales</p>
                        <h3 class="text-3xl font-bold text-purple-600">$${totalRevenue}</h3>
                    </div>
                    <i class="fas fa-dollar-sign text-purple-400 text-4xl"></i>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Cuentas Pendientes</p>
                        <h3 class="text-3xl font-bold text-red-600">${pendingAccounts}</h3>
                    </div>
                    <i class="fas fa-exclamation-triangle text-red-400 text-4xl"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Productos con más Stock</h3>
                    <ul>${topProductsHtml}</ul>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Ventas Recientes</h3>
                    <ul>${recentSalesHtml}</ul>
                </div>
            </div>
        `;
    }

    // --- NUEVA FUNCIÓN: Renderiza solo la ESTRUCTURA principal de Nueva Venta ---
    function renderNuevaVentaStructure() {
        // Incluye una opción "Nuevo Cliente" en el select
        const customerOptions = `
            <option value="general">Cliente General</option>
            <option value="new-customer">Nuevo Cliente (llenar datos)</option>
            ${state.clientes.map(c => `<option value="${c.id}">${c.nombre} (C.I./RUC: ${c.cedula || 'N/A'})</option>`).join('')}
        `;

        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Nueva Venta</h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Seleccionar Productos</h3>
                    <div class="mb-4 flex items-center space-x-2">
                        <input type="text" id="product-search" placeholder="Buscar producto por nombre o código..." class="flex-1 p-2 border border-gray-300 rounded-md shadow-sm" value="${state.searchTerm}" oninput="updateSearchTerm(this.value)">
                        <button onclick="startScanner()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-md shadow-sm">
                            <i class="fas fa-barcode text-lg"></i>
                        </button>
                    </div>
                    <div id="barcode-scanner-container" style="display: none;">
                        <video id="barcode-scanner-video" style="width:100%; height:100%; object-fit: cover;"></video>
                        <div class="scan-region"></div>
                    </div>
                    <div id="products-grid" class="products-grid max-h-96-overflow">
                        </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Detalle de la Venta</h3>
                    <div class="mb-4">
                        <label for="selected-customer" class="block text-sm font-medium text-gray-700 mb-1">Cliente:</label>
                        <select id="selected-customer" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" onchange="toggleCustomerDetailsFields(this.value)">
                            ${customerOptions}
                        </select>
                    </div>

                    <div id="customer-details-fields" class="space-y-3 mb-4" style="display: none;">
                        <h4 class="text-md font-semibold text-gray-800 border-b pb-2">Datos del Cliente</h4>
                        <div>
                            <label for="new-customer-cedula" class="block text-sm font-medium text-gray-700">Cédula/RUC:</label>
                            <input type="text" id="new-customer-cedula" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Cédula o RUC">
                        </div>
                        <div>
                            <label for="new-customer-nombres" class="block text-sm font-medium text-gray-700">Nombres/Razón Social:</label>
                            <input type="text" id="new-customer-nombres" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Nombres o Razón Social">
                        </div>
                        <div>
                            <label for="new-customer-telefono" class="block text-sm font-medium text-gray-700">Teléfono:</label>
                            <input type="text" id="new-customer-telefono" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Teléfono">
                        </div>
                        <div>
                            <label for="new-customer-celular" class="block text-sm font-medium text-gray-700">Celular:</label>
                            <input type="text" id="new-customer-celular" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Celular (opcional)">
                        </div>
                    </div>

                    <div id="cart-items" class="border rounded-md max-h-48-overflow mb-4">
                        </div>

                    <div class="border-t pt-4 mt-4 space-y-2">
                        <div class="flex justify-between text-lg">
                            <span>Subtotal:</span>
                            <span id="cart-subtotal">$0.00</span>
                        </div>
                        <div class="flex justify-between text-2xl font-bold text-blue-600">
                            <span>Total:</span>
                            <span id="cart-total">$0.00</span>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <label for="amount-received" class="block text-sm font-medium text-gray-700 mb-1">Monto Recibido:</label>
                            <input type="number" id="amount-received" placeholder="Ingrese monto" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-lg font-bold" value="${state.amountReceived > 0 ? state.amountReceived : ''}" oninput="updateAmountReceived(this.value)" step="0.01">
                        </div>
                        <div class="flex justify-between text-xl font-bold text-green-600 mt-2">
                            <span>Cambio:</span>
                            <span id="cart-change">$0.00</span>
                        </div>
                        </div>

                    <button onclick="processSaleWrapper()" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                        <i class="fas fa-check-circle mr-2"></i> Procesar Venta
                    </button>
                </div>
            </div>
        `;
        // Asignar el valor de amountReceived al input después de que se renderiza el HTML
        const amountReceivedInput = document.getElementById('amount-received');
        if (amountReceivedInput) {
            amountReceivedInput.value = state.amountReceived > 0 ? state.amountReceived : '';
        }
        // Llamar a la función que renderiza los productos y el carrito después de que la estructura esté en el DOM
        renderFilteredProducts();
        renderCartItems();
        updateCartTotalsDisplay(); // Asegúrate de que los totales se muestren correctamente al cargar la estructura

        // NUEVA FUNCIONALIDAD: Restaurar el estado del selector de cliente y mostrar/ocultar campos si aplica
        const selectedCustomerElement = document.getElementById('selected-customer');
        if (selectedCustomerElement) {
            // Verifica si el cliente "general" o un cliente existente estaba seleccionado
            const currentCustomerId = state.currentSaleCustomerId || 'general'; // Asumimos un nuevo estado para recordar la selección
            selectedCustomerElement.value = currentCustomerId;
            toggleCustomerDetailsFields(currentCustomerId); // Llama a la función para ajustar la visibilidad
        }
        // NUEVA FUNCIONALIDAD: Rellenar campos del cliente si es uno existente
        if (state.currentSaleCustomerId && state.currentSaleCustomerId !== 'general' && state.currentSaleCustomerId !== 'new-customer') {
            const selectedClient = state.clientes.find(c => c.id === state.currentSaleCustomerId);
            if (selectedClient) {
                document.getElementById('new-customer-cedula').value = selectedClient.cedula || '';
                document.getElementById('new-customer-nombres').value = selectedClient.nombre || '';
                document.getElementById('new-customer-telefono').value = selectedClient.telefono || '';
                document.getElementById('new-customer-celular').value = selectedClient.celular || '';
            }
        }
    }

    // NUEVA FUNCIONALIDAD: Función para mostrar/ocultar los campos de detalles del cliente
    window.toggleCustomerDetailsFields = (selectedValue) => {
        const customerDetailsDiv = document.getElementById('customer-details-fields');
        const cedulaInput = document.getElementById('new-customer-cedula');
        const nombresInput = document.getElementById('new-customer-nombres');
        const telefonoInput = document.getElementById('new-customer-telefono');
        const celularInput = document.getElementById('new-customer-celular');

        // Limpiar campos y quitar requeridos al cambiar de opción
        cedulaInput.value = '';
        nombresInput.value = '';
        telefonoInput.value = '';
        celularInput.value = '';
        cedulaInput.removeAttribute('required');
        nombresInput.removeAttribute('required');
        telefonoInput.removeAttribute('required');

        if (selectedValue === 'new-customer') {
            customerDetailsDiv.style.display = 'block';
            cedulaInput.setAttribute('required', 'true');
            nombresInput.setAttribute('required', 'true');
            telefonoInput.setAttribute('required', 'true');
            // Celular no es requerido por tu solicitud
        } else if (selectedValue !== 'general') {
            // Si se selecciona un cliente existente, mostrar los campos pero no requerirlos
            // y rellenar con la información del cliente
            customerDetailsDiv.style.display = 'block';
            const selectedClient = state.clientes.find(c => c.id === selectedValue);
            if (selectedClient) {
                cedulaInput.value = selectedClient.cedula || '';
                nombresInput.value = selectedClient.nombre || '';
                telefonoInput.value = selectedClient.telefono || '';
                celularInput.value = selectedClient.celular || '';
            }
        } else {
            customerDetailsDiv.style.display = 'none';
        }
        state.currentSaleCustomerId = selectedValue; // Almacenar la selección actual del cliente
    };

    // --- NUEVA FUNCIÓN: Renderiza solo los productos filtrados ---
    function renderFilteredProducts() {
        const filteredProducts = state.productos.filter(p =>
            p.name.toLowerCase().includes(state.searchTerm) ||
            p.barcode.toLowerCase().includes(state.searchTerm)
        );

        const productsGridElement = document.getElementById('products-grid');
        if (!productsGridElement) return; // Salir si el elemento no existe (no estamos en Nueva Venta)

        productsGridElement.innerHTML = filteredProducts.length > 0 ? filteredProducts.map(p => `
            <div class="bg-white p-4 rounded-lg shadow-sm product-card" onclick="addToCart('${p.id}')">
                <img src="https://via.placeholder.com/80" alt="${p.name}" class="mx-auto mb-2 rounded">
                <h4 class="font-medium text-sm truncate">${p.name}</h4>
                <p class="text-gray-600 text-xs">Stock: ${p.stock}</p>
                <p class="text-blue-600 font-bold mt-1">$${p.price.toFixed(2)}</p>
            </div>
        `).join('') : '<p class="text-center text-gray-500 col-span-full">No hay productos disponibles o que coincidan con la búsqueda.</p>';
    }

    // --- NUEVA FUNCIÓN: Renderiza solo los ítems del carrito ---
    function renderCartItems() {
        const cartItemsElement = document.getElementById('cart-items');
        if (!cartItemsElement) return;

        cartItemsElement.innerHTML = state.cart.length > 0 ? state.cart.map(item => `
            <div class="flex items-center justify-between p-3 border-b last:border-b-0">
                <div class="flex-1">
                    <p class="font-medium">${item.name}</p>
                    <p class="text-sm text-gray-600">$${item.price.toFixed(2)} c/u</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="updateCartQuantity('${item.id}', -1)" class="bg-red-200 text-red-700 w-7 h-7 rounded-full text-sm flex items-center justify-center">-</button>
                    <span class="font-semibold">${item.cantidad}</span>
                    <button onclick="updateCartQuantity('${item.id}', 1)" class="bg-green-200 text-green-700 w-7 h-7 rounded-full text-sm flex items-center justify-center">+</button>
                    <button onclick="removeFromCart('${item.id}')" class="ml-2 text-gray-500 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        `).join('') : '<p class="text-center text-gray-500">El carrito está vacío.</p>';
    }

    // --- NUEVA FUNCIÓN: Actualiza solo los totales en la UI ---
    function updateCartTotalsDisplay() {
        const { subtotal, total } = calculateCartTotals();
        const change = calculateChange();

        const cartSubtotalElement = document.getElementById('cart-subtotal');
        const cartTotalElement = document.getElementById('cart-total');
        const cartChangeElement = document.getElementById('cart-change');

        if (cartSubtotalElement) cartSubtotalElement.textContent = `$${subtotal.toFixed(2)}`;
        if (cartTotalElement) cartTotalElement.textContent = `$${total.toFixed(2)}`;
        if (cartChangeElement) cartChangeElement.textContent = `$${change.toFixed(2)}`;
    }

    // --- FUNCIÓN ORIGINAL `renderNuevaVenta` AHORA ES `renderNuevaVentaStructure` ---
    // Y las funciones `renderFilteredProducts`, `renderCartItems` y `updateCartTotalsDisplay`
    // se encargan de las actualizaciones más granulares.

    // Función para actualizar el término de búsqueda y re-renderizar la sección de venta
    // *** MODIFICADO PARA NO RE-RENDERIZAR TODO EL CONTAINER ***
    window.updateSearchTerm = (value) => {
        state.searchTerm = value.toLowerCase();
        renderFilteredProducts(); // Solo actualiza la cuadrícula de productos
    };

    // Función para actualizar el monto recibido y recalcular el cambio
    window.updateAmountReceived = (value) => {
        state.amountReceived = parseFloat(value) || 0;
        // Solo actualiza los campos de cambio sin re-renderizar toda la sección
        // Esto es más eficiente que llamar a renderNuevaVenta()
        const { total } = calculateCartTotals();
        const change = calculateChange();
        document.getElementById('cart-change').textContent = `$${change.toFixed(2)}`;
        // Opcional: Si quieres que el total se actualice con IVA 0, puedes forzarlo aquí si se cambia manualmente
        // document.getElementById('cart-total').textContent = `$${total.toFixed(2)}`;
    };

    // Nueva función para calcular el cambio
    function calculateChange() {
        const { total } = calculateCartTotals();
        return Math.max(0, state.amountReceived - total); // El cambio no puede ser negativo
    }


    function renderVentas() {
        const salesHtml = state.ventas.length > 0 ? state.ventas.map(sale => {
            const saleDate = sale.fecha ? new Date(sale.fecha.toDate()).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.id.substring(0, 8)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${saleDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sale.clienteNombre || 'Cliente General'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${sale.total ? sale.total.toFixed(2) : '0.00'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${sale.estado === 'Completada' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${sale.estado}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="viewSaleDetails('${sale.id}')" class="text-blue-600 hover:text-blue-900 mr-2"><i class="fas fa-eye"></i></button>
                        <button onclick="deleteSale('${sale.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `;
        }).join('') : `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay ventas registradas.</td></tr>`;

        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Historial de Ventas</h2>
            <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Venta</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${salesHtml}
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderCuentasPorCobrar() {
        // Mejoras: Filtro por estado, ordenar por fecha de vencimiento.
        const filterState = document.getElementById('filter-cuenta-estado')?.value || 'Todos';
        const sortedCuentas = [...state.cuentas_por_cobrar].sort((a, b) => {
            const dateA = a.fechaVencimiento?.toDate() || new Date(0);
            const dateB = b.fechaVencimiento?.toDate() || new Date(0);
            return dateA - dateB;
        });

        const filteredCuentas = sortedCuentas.filter(cuenta => {
            if (filterState === 'Todos') return true;
            return cuenta.estado === filterState;
        });

        const cuentasHtml = filteredCuentas.length > 0 ? filteredCuentas.map(cuenta => {
            const cliente = state.clientes.find(c => c.id === cuenta.clienteId);
            const clienteNombre = cliente ? cliente.nombre : 'Desconocido';
            const fechaCreacion = cuenta.fechaCreacion ? new Date(cuenta.fechaCreacion.toDate()).toLocaleDateString('es-ES') : 'N/A';
            const fechaVencimiento = cuenta.fechaVencimiento ? new Date(cuenta.fechaVencimiento.toDate()).toLocaleDateString('es-ES') : 'N/A';
            let statusClass = '';
            if (cuenta.estado === 'Pagada') {
                statusClass = 'bg-green-100 text-green-800';
            } else if (cuenta.estado === 'Vencida') {
                statusClass = 'bg-red-100 text-red-800';
            } else {
                statusClass = 'bg-yellow-100 text-yellow-800';
            }

            return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cuenta.id.substring(0, 8)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${clienteNombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${cuenta.monto ? cuenta.monto.toFixed(2) : '0.00'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cuenta.concepto}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fechaVencimiento}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${cuenta.estado}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="showCuentaPorCobrarForm(${JSON.stringify(cuenta).replace(/'/g, "\\'")})" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="markCuentaAsPaid('${cuenta.id}')" class="text-green-600 hover:text-green-900 mr-2 ${cuenta.estado === 'Pagada' ? 'cursor-not-allowed opacity-50' : ''}" ${cuenta.estado === 'Pagada' ? 'disabled' : ''} title="Marcar como Pagada"><i class="fas fa-check-circle"></i></button>
                        <button onclick="deleteCuentaPorCobrar('${cuenta.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `;
        }).join('') : `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No hay cuentas por cobrar registradas.</td></tr>`;

        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Cuentas por Cobrar</h2>
            <div class="flex justify-between items-center mb-4">
                <button onclick="showCuentaPorCobrarForm()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-plus mr-2"></i> Añadir Cuenta por Cobrar
                </button>
                <div class="flex items-center space-x-2">
                    <label for="filter-cuenta-estado" class="text-sm font-medium text-gray-700">Filtrar por Estado:</label>
                    <select id="filter-cuenta-estado" onchange="renderCuentasPorCobrar()" class="p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="Todos" ${filterState === 'Todos' ? 'selected' : ''}>Todos</option>
                        <option value="Pendiente" ${filterState === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                        <option value="Pagada" ${filterState === 'Pagada' ? 'selected' : ''}>Pagada</option>
                        <option value="Vencida" ${filterState === 'Vencida' ? 'selected' : ''}>Vencida</option>
                    </select>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Cuenta</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vencimiento</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${cuentasHtml}
                    </tbody>
                </table>
            </div>
        `;
        // Para asegurar que el filtro se mantenga, establece el valor del select
        document.getElementById('filter-cuenta-estado').value = filterState;
    }

    function renderAlmacen() {
        const productsHtml = state.productos.length > 0 ? state.productos.map(product => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.barcode}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.category}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${product.price ? product.price.toFixed(2) : '0.00'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${product.stock > 10 ? 'bg-green-100 text-green-800' : product.stock > 0 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                        ${product.stock}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="showProductForm(${JSON.stringify(product).replace(/'/g, "\\'")})" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>
        `).join('') : `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay productos registrados.</td></tr>`;

        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Gestión de Almacén</h2>
            <div class="flex justify-end mb-4">
                <button onclick="showProductForm()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-plus mr-2"></i> Añadir Producto
                </button>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código de Barras</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${productsHtml}
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderClientes() {
        // NUEVA FUNCIONALIDAD: Mostrar cédula y celular en la tabla de clientes
        const customersHtml = state.clientes.length > 0 ? state.clientes.map(customer => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.cedula || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.telefono || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.celular || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${customer.totalCompras ? customer.totalCompras.toFixed(2) : '0.00'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="showCustomerForm(${JSON.stringify(customer).replace(/'/g, "\\'")})" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>
        `).join('') : `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay clientes registrados.</td></tr>`;

        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Gestión de Clientes</h2>
            <div class="flex justify-end mb-4">
                <button onclick="showCustomerForm()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-plus mr-2"></i> Añadir Cliente
                </button>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre/Razón Social</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cédula/RUC</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Celular</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Compras</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${customersHtml}
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderEmpleados() {
        const employeesHtml = state.empleados.length > 0 ? state.empleados.map(employee => `
            <tr class="border-b hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.nombre}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.cargo || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.telefono || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="showEmployeeForm(${JSON.stringify(employee).replace(/'/g, "\\'")})" class="text-indigo-600 hover:text-indigo-900 mr-2"><i class="fas fa-edit"></i></button>
                    <button onclick="deleteEmployee('${employee.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash-alt"></i></button>
                </td>
            </tr>
        `).join('') : `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No hay empleados registrados.</td></tr>`;

        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Gestión de Empleados</h2>
            <div class="flex justify-end mb-4">
                <button onclick="showEmployeeForm()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-plus mr-2"></i> Añadir Empleado
                </button>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cargo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Acciones</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${employeesHtml}
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderReportes() {
        const totalSales = state.ventas.length;
        const totalRevenue = state.ventas.reduce((sum, venta) => sum + (venta.total || 0), 0).toFixed(2);
        const productsLowStock = state.productos.filter(p => p.stock <= 5 && p.stock > 0).length;
        const productsOutOfStock = state.productos.filter(p => p.stock === 0).length;
        const salesByMonth = {};
        state.ventas.forEach(sale => {
            if (sale.fecha) {
                const date = new Date(sale.fecha.toDate());
                const monthYear = `${date.toLocaleString('es-ES', { month: 'long' })} ${date.getFullYear()}`;
                salesByMonth[monthYear] = (salesByMonth[monthYear] || 0) + (sale.total || 0);
            }
        });

        let salesByMonthHtml = Object.entries(salesByMonth).map(([month, total]) => `
            <li class="flex justify-between py-2 border-b last:border-b-0">
                <span>${month}</span>
                <span class="font-semibold text-blue-600">$${total.toFixed(2)}</span>
            </li>
        `).join('');
        if (Object.keys(salesByMonth).length === 0) {
            salesByMonthHtml = '<p class="text-gray-500 text-sm">No hay datos de ventas por mes.</p>';
        }


        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Reportes y Estadísticas</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Total Ventas (Cantidad)</p>
                        <h3 class="text-3xl font-bold text-blue-600">${totalSales}</h3>
                    </div>
                    <i class="fas fa-receipt text-blue-400 text-4xl"></i>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Total Ingresos</p>
                        <h3 class="text-3xl font-bold text-green-600">$${totalRevenue}</h3>
                    </div>
                    <i class="fas fa-money-bill-wave text-green-400 text-4xl"></i>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Productos con poco Stock (&lt;=5)</p>
                        <h3 class="text-3xl font-bold text-yellow-600">${productsLowStock}</h3>
                    </div>
                    <i class="fas fa-exclamation-circle text-yellow-400 text-4xl"></i>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-between">
                    <div>
                        <p class="text-gray-500">Productos sin Stock (0)</p>
                        <h3 class="text-3xl font-bold text-red-600">${productsOutOfStock}</h3>
                    </div>
                    <i class="fas fa-times-circle text-red-400 text-4xl"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4">Ingresos por Mes</h3>
                    <ul>${salesByMonthHtml}</ul>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-center text-gray-500">
                    <p>Espacio para futuros gráficos de reportes.</p>
                </div>
            </div>
        `;
    }

    // NUEVA FUNCIONALIDAD: Renderizar y gestionar la configuración del negocio
    function renderConfiguracionNegocio() {
        const business = state.businessInfo;
        DOMElements.contentArea.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Configuración del Negocio</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold mb-4">Datos de la Empresa para Facturas/Recibos</h3>
                <form id="business-info-form" class="space-y-4">
                    <div>
                        <label for="business-name" class="block text-sm font-medium text-gray-700">Nombre de la Empresa:</label>
                        <input type="text" id="business-name" name="nombre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${business.nombre || ''}" required>
                    </div>
                    <div>
                        <label for="business-address" class="block text-sm font-medium text-gray-700">Dirección:</label>
                        <input type="text" id="business-address" name="direccion" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${business.direccion || ''}" required>
                    </div>
                    <div>
                        <label for="business-phone" class="block text-sm font-medium text-gray-700">Teléfono:</label>
                        <input type="text" id="business-phone" name="telefono" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${business.telefono || ''}" required>
                    </div>
                    <div>
                        <label for="business-ruc" class="block text-sm font-medium text-gray-700">RUC/Identificación Fiscal:</label>
                        <input type="text" id="business-ruc" name="ruc" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${business.ruc || ''}" required>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            <i class="fas fa-save mr-2"></i> Guardar Configuración
                        </button>
                    </div>
                </form>
            </div>
        `;

        document.getElementById('business-info-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                nombre: formData.get('nombre'),
                direccion: formData.get('direccion'),
                telefono: formData.get('telefono'),
                ruc: formData.get('ruc')
            };
            await updateBusinessInfo(data);
        });
    }

    // NUEVA FUNCIONALIDAD: Guardar/Actualizar la información del negocio en Firebase
    window.updateBusinessInfo = async (businessData) => {
        try {
            // Usamos setDoc con merge: true para crear el documento si no existe o actualizarlo
            await setDoc(doc(db, "configuracion", "negocio"), businessData, { merge: true });
            state.businessInfo = { ...businessData }; // Actualizar el estado local
            alert('Información del negocio guardada exitosamente!');
            renderConfiguracionNegocio(); // Volver a renderizar para reflejar los cambios
        } catch (e) {
            console.error("Error al guardar la información del negocio: ", e);
            alert('Error al guardar la información del negocio.');
        }
    }


    // --- FASE 5: TODAS LAS DEMÁS FUNCIONES (CRUD, Lógica de Venta, etc.) ---

    // Funciones para Almacén (Productos)
    window.addProduct = async (productData) => {
        try {
            await addDoc(collection(db, "productos"), productData);
            await fetchData('productos');
            alert('Producto añadido exitosamente!');
            renderAlmacen();
        } catch (e) {
            console.error("Error añadiendo producto: ", e);
            alert('Error añadiendo producto.');
        }
    }

    window.updateProduct = async (id, productData) => {
        try {
            const productRef = doc(db, "productos", id);
            await updateDoc(productRef, productData);
            await fetchData('productos');
            alert('Producto actualizado exitosamente!');
            renderAlmacen();
        } catch (e) {
            console.error("Error actualizando producto: ", e);
            alert('Error actualizando producto.');
        }
    }

    window.deleteProduct = async (id) => {
        if (!confirm('¿Estás seguro de que quieres eliminar este producto?')) return;
        try {
            await deleteDoc(doc(db, "productos", id));
            await fetchData('productos');
            alert('Producto eliminado exitosamente!');
            renderAlmacen();
        } catch (e) {
            console.error("Error eliminando producto: ", e);
            alert('Error eliminando producto.');
        }
    }

    window.showProductForm = (product = null) => {
        const isEditing = product !== null;
        const title = isEditing ? 'Editar Producto' : 'Nuevo Producto';
        const submitText = isEditing ? 'Actualizar' : 'Guardar';

        const formHtml = `
            <h3 class="text-xl font-semibold mb-4">${title}</h3>
            <form id="product-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="name" name="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${product ? product.name : ''}" required>
                </div>
                <div>
                    <label for="barcode" class="block text-sm font-medium text-gray-700">Código de Barras</label>
                    <input type="text" id="barcode" name="barcode" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${product ? product.barcode : ''}" required>
                </div>
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700">Categoría</label>
                    <input type="text" id="category" name="category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${product ? product.category : ''}" required>
                </div>
                <div>
                    <label for="price" class="block text-sm font-medium text-gray-700">Precio</label>
                    <input type="number" id="price" name="price" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${product ? product.price : ''}" required>
                </div>
                <div>
                    <label for="stock" class="block text-sm font-medium text-gray-700">Stock</label>
                    <input type="number" id="stock" name="stock" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${product ? product.stock : ''}" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">${submitText}</button>
                </div>
            </form>
        `;
        window.showModal(formHtml);

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                barcode: formData.get('barcode'),
                category: formData.get('category'),
                price: parseFloat(formData.get('price')),
                stock: parseInt(formData.get('stock')),
            };
            if (isEditing) {
                await window.updateProduct(product.id, data);
            } else {
                await window.addProduct(data);
            }
            window.hideModal();
            // Después de añadir/actualizar, regresa al almacén si no estabas ya ahí.
            window.showSection('almacen-section');
        });
    }

    // Funciones para Clientes
    window.addCustomer = async (customerData) => {
        try {
            await addDoc(collection(db, "clientes"), {...customerData, totalCompras: 0});
            await fetchData('clientes');
            alert('Cliente añadido exitosamente!');
            renderClientes();
        } catch (e) {
            console.error("Error añadiendo cliente: ", e);
            alert('Error añadiendo cliente.');
        }
    }

    window.updateCustomer = async (id, customerData) => {
        try {
            const customerRef = doc(db, "clientes", id);
            await updateDoc(customerRef, customerData);
            await fetchData('clientes');
            alert('Cliente actualizado exitosamente!');
            renderClientes();
        } catch (e) {
            console.error("Error actualizando cliente: ", e);
            alert('Error actualizando cliente.');
        }
    }

    window.deleteCustomer = async (id) => {
        if (!confirm('¿Estás seguro de que quieres eliminar este cliente?')) return;
        try {
            await deleteDoc(doc(db, "clientes", id));
            await fetchData('clientes');
            alert('Cliente eliminado exitosamente!');
            renderClientes();
        } catch (e) {
            console.error("Error eliminando cliente: ", e);
            alert('Error eliminando cliente.');
        }
    }

    window.showCustomerForm = (customer = null) => {
        const isEditing = customer !== null;
        const title = isEditing ? 'Editar Cliente' : 'Nuevo Cliente';
        const submitText = isEditing ? 'Actualizar' : 'Guardar';

        // NUEVA FUNCIONALIDAD: Campos para cédula y celular en el formulario de cliente
        const formHtml = `
            <h3 class="text-xl font-semibold mb-4">${title}</h3>
            <form id="customer-form" class="space-y-4">
                <div>
                    <label for="nombreCliente" class="block text-sm font-medium text-gray-700">Nombres / Razón Social</label>
                    <input type="text" id="nombreCliente" name="nombre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer ? customer.nombre : ''}" required>
                </div>
                <div>
                    <label for="cedulaCliente" class="block text-sm font-medium text-gray-700">Cédula / RUC</label>
                    <input type="text" id="cedulaCliente" name="cedula" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer ? customer.cedula : ''}" required>
                </div>
                <div>
                    <label for="telefonoCliente" class="block text-sm font-medium text-gray-700">Teléfono Convencional</label>
                    <input type="text" id="telefonoCliente" name="telefono" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer ? customer.telefono : ''}">
                </div>
                <div>
                    <label for="celularCliente" class="block text-sm font-medium text-gray-700">Teléfono Celular</label>
                    <input type="text" id="celularCliente" name="celular" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer ? customer.celular : ''}">
                </div>
                <div>
                    <label for="emailCliente" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="emailCliente" name="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${customer ? customer.email : ''}">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">${submitText}</button>
                </div>
            </form>
        `;
        window.showModal(formHtml);

        document.getElementById('customer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                nombre: formData.get('nombre'),
                cedula: formData.get('cedula'), // NUEVA FUNCIONALIDAD: Cédula
                telefono: formData.get('telefono'),
                celular: formData.get('celular'), // NUEVA FUNCIONALIDAD: Celular
                email: formData.get('email'),
            };
            if (isEditing) {
                await window.updateCustomer(customer.id, data);
            } else {
                await window.addCustomer(data);
            }
            window.hideModal();
            // Después de añadir/actualizar, regresa a la sección de clientes si no estabas ya ahí.
            window.showSection('clientes-section');
        });
    }

    // Funciones para Empleados
    window.addEmployee = async (employeeData) => {
        try {
            await addDoc(collection(db, "empleados"), employeeData);
            await fetchData('empleados');
            alert('Empleado añadido exitosamente!');
            renderEmpleados();
        } catch (e) {
            console.error("Error añadiendo empleado: ", e);
            alert('Error añadiendo empleado.');
        }
    }

    window.updateEmployee = async (id, employeeData) => {
        try {
            const employeeRef = doc(db, "empleados", id);
            await updateDoc(employeeRef, employeeData);
            await fetchData('empleados');
            alert('Empleado actualizado exitosamente!');
            renderEmpleados();
        } catch (e) {
            console.error("Error actualizando empleado: ", e);
            alert('Error actualizando empleado.');
        }
    }

    window.deleteEmployee = async (id) => {
        if (!confirm('¿Estás seguro de que quieres eliminar este empleado?')) return;
        try {
            await deleteDoc(doc(db, "empleados", id));
            await fetchData('empleados');
            alert('Empleado eliminado exitosamente!');
            renderEmpleados();
        } catch (e) {
            console.error("Error eliminando empleado: ", e);
            alert('Error eliminando empleado.');
        }
    }

    window.showEmployeeForm = (employee = null) => {
        const isEditing = employee !== null;
        const title = isEditing ? 'Editar Empleado' : 'Nuevo Empleado';
        const submitText = isEditing ? 'Actualizar' : 'Guardar';

        const formHtml = `
            <h3 class="text-xl font-semibold mb-4">${title}</h3>
            <form id="employee-form" class="space-y-4">
                <div>
                    <label for="nombreEmpleado" class="block text-sm font-medium text-gray-700">Nombre</label>
                    <input type="text" id="nombreEmpleado" name="nombre" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${employee ? employee.nombre : ''}" required>
                </div>
                <div>
                    <label for="cargoEmpleado" class="block text-sm font-medium text-gray-700">Cargo</label>
                    <input type="text" id="cargoEmpleado" name="cargo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${employee ? employee.cargo : ''}">
                </div>
                <div>
                    <label for="telefonoEmpleado" class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="text" id="telefonoEmpleado" name="telefono" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${employee ? employee.telefono : ''}">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">${submitText}</button>
                </div>
            </form>
        `;
        window.showModal(formHtml);

        document.getElementById('employee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                nombre: formData.get('nombre'),
                cargo: formData.get('cargo'),
                telefono: formData.get('telefono'),
            };
            if (isEditing) {
                await window.updateEmployee(employee.id, data);
            } else {
                await window.addEmployee(data);
            }
            window.hideModal();
        });
    }

    // Funciones para Nueva Venta
    window.addToCart = (productId) => {
        const product = state.productos.find(p => p.id === productId);
        if (!product) {
            console.error("Producto no encontrado:", productId);
            return;
        }

        const existingItemIndex = state.cart.findIndex(item => item.id === productId);

        if (existingItemIndex > -1) {
            const newCart = [...state.cart];
            if (newCart[existingItemIndex].cantidad < product.stock) {
                newCart[existingItemIndex].cantidad += 1;
            } else {
                alert('No hay suficiente stock para este producto.');
            }
            state.cart = newCart;
        } else {
            if (product.stock > 0) {
                state.cart = [...state.cart, { ...product, cantidad: 1 }];
            } else {
                alert('Este producto no tiene stock disponible.');
            }
        }
        renderCartItems(); // Solo actualiza el carrito
        updateCartTotalsDisplay(); // Actualiza los totales
    };

    window.updateCartQuantity = (productId, change) => {
        const product = state.productos.find(p => p.id === productId);
        if (!product) return;

        const newCart = state.cart.map(item => {
            if (item.id === productId) {
                const newQuantity = item.cantidad + change;
                if (newQuantity <= 0) return null; // Elimina el item si la cantidad es 0 o menos
                if (newQuantity > product.stock) {
                    alert('No hay suficiente stock.');
                    return item;
                }
                return { ...item, cantidad: newQuantity };
            }
            return item;
        }).filter(item => item !== null); // Filtra los items que son null (eliminados)

        state.cart = newCart;
        renderCartItems(); // Solo actualiza el carrito
        updateCartTotalsDisplay(); // Actualiza los totales
    };

    window.removeFromCart = (productId) => {
        state.cart = state.cart.filter(item => item.id !== productId);
        renderCartItems(); // Solo actualiza el carrito
        updateCartTotalsDisplay(); // Actualiza los totales
    };

    function calculateCartTotals() {
        const subtotal = state.cart.reduce((sum, item) => sum + (item.price * item.cantidad), 0);
        // const iva = subtotal * IVA_RATE; // Eliminado
        // const total = subtotal + iva; // Modificado
        const total = subtotal; // El total es igual al subtotal sin IVA
        return { subtotal, total }; // Retorna solo subtotal y total
    }

    window.processSaleWrapper = async () => {
        const selectedCustomerElement = document.getElementById('selected-customer');
        let clienteId = selectedCustomerElement ? selectedCustomerElement.value : 'general';
        const metodoPago = 'efectivo'; // Podrías añadir un selector de método de pago en el futuro
        
        // NUEVA FUNCIONALIDAD: Lógica para cliente nuevo
        let clienteDataForSale = {}; // Objeto para guardar los datos del cliente en la venta
        if (clienteId === 'new-customer') {
            const cedula = document.getElementById('new-customer-cedula').value.trim();
            const nombres = document.getElementById('new-customer-nombres').value.trim();
            const telefono = document.getElementById('new-customer-telefono').value.trim();
            const celular = document.getElementById('new-customer-celular').value.trim();

            if (!cedula || !nombres || !telefono) {
                alert('Por favor, complete los campos de Cédula/RUC, Nombres/Razón Social y Teléfono para el nuevo cliente.');
                return;
            }

            // Verificar si el cliente ya existe por cédula
            const existingClient = state.clientes.find(c => c.cedula === cedula);
            if (existingClient) {
                alert('Ya existe un cliente con esta Cédula/RUC. Por favor, seleccione el cliente existente o ingrese una cédula diferente.');
                return;
            }

            try {
                // Añadir el nuevo cliente a la base de datos
                const newClientRef = await addDoc(collection(db, "clientes"), {
                    cedula: cedula,
                    nombre: nombres,
                    telefono: telefono,
                    celular: celular,
                    email: '', // Puedes añadir un campo de email si lo deseas en el formulario de cliente
                    totalCompras: 0
                });
                clienteId = newClientRef.id; // Asignar el ID del nuevo cliente para la venta
                clienteDataForSale = {
                    clienteId: clienteId,
                    clienteNombre: nombres,
                    clienteCedula: cedula,
                    clienteTelefono: telefono,
                    clienteCelular: celular
                };
                await fetchData('clientes'); // Actualizar la lista de clientes en el estado
                alert('Nuevo cliente registrado exitosamente.');
            } catch (error) {
                console.error("Error al registrar nuevo cliente:", error);
                alert('Hubo un error al registrar el nuevo cliente. La venta no se procesará.');
                return;
            }
        } else if (clienteId !== 'general') {
            // Si es un cliente existente, obtener sus datos completos
            const existingClient = state.clientes.find(c => c.id === clienteId);
            if (existingClient) {
                clienteDataForSale = {
                    clienteId: clienteId,
                    clienteNombre: existingClient.nombre,
                    clienteCedula: existingClient.cedula || 'N/A',
                    clienteTelefono: existingClient.telefono || 'N/A',
                    clienteCelular: existingClient.celular || 'N/A'
                };
            }
        } else {
            // Cliente general, no hay datos adicionales
            clienteDataForSale = {
                clienteId: null,
                clienteNombre: 'Cliente General',
                clienteCedula: 'N/A',
                clienteTelefono: 'N/A',
                clienteCelular: 'N/A'
            };
        }

        // Validar que se ha ingresado un monto recibido suficiente
        const { total } = calculateCartTotals();
        if (state.amountReceived < total) {
            alert('El monto recibido es menor que el total de la venta. Por favor, ingrese un monto suficiente.');
            return;
        }
        await processSale(clienteId, metodoPago, clienteDataForSale);
    };

    window.processSale = async (clienteId, metodoPago, clienteDataForSale) => {
        if (state.cart.length === 0) {
            alert('El carrito está vacío. Agrega productos para procesar la venta.');
            return;
        }

        // Reutiliza los datos del cliente preparados en processSaleWrapper
        const { clienteNombre, clienteCedula, clienteTelefono, clienteCelular } = clienteDataForSale;
        const { subtotal, total } = calculateCartTotals(); // Recoge solo subtotal y total
        const currentTimestamp = new Date(); // Usar una fecha actual para el recibo

        const saleData = {
            fecha: serverTimestamp(), // Esto se guardará en Firestore
            fechaLocal: currentTimestamp.toISOString(), // Guardar la fecha local para el recibo
            clienteId: clienteId === 'general' ? null : clienteId,
            clienteNombre: clienteNombre,
            // NUEVA FUNCIONALIDAD: Guardar datos de cédula, teléfono y celular en la venta
            clienteCedula: clienteCedula,
            clienteTelefono: clienteTelefono,
            clienteCelular: clienteCelular,
            items: state.cart.map(item => ({
                productoId: item.id,
                nombre: item.name,
                cantidad: item.cantidad,
                precioUnitario: item.price
            })),
            subtotal: subtotal,
            iva: 0, // IVA es 0 según la solicitud
            total: total,
            metodoPago: metodoPago,
            estado: 'Completada',
            montoRecibido: state.amountReceived, // Guarda el monto recibido
            cambio: calculateChange() // Guarda el cambio
        };

        try {
            const batch = writeBatch(db);

            const newSaleRef = doc(collection(db, "ventas"));
            batch.set(newSaleRef, saleData);

            for (const item of state.cart) {
                const productRef = doc(db, "productos", item.id);
                const currentProduct = state.productos.find(p => p.id === item.id);
                if (currentProduct) {
                    const updatedStock = currentProduct.stock - item.cantidad;
                    batch.update(productRef, { stock: updatedStock });
                }
            }

            if (clienteId !== 'general') {
                const customerRef = doc(db, "clientes", clienteId);
                const currentCustomer = state.clientes.find(c => c.id === clienteId);
                const newTotalCompras = (currentCustomer?.totalCompras || 0) + total;
                batch.update(customerRef, { totalCompras: newTotalCompras });
            }

            await batch.commit();
            alert('¡Venta procesada y stock actualizado exitosamente!');
            
            // Generar y mostrar el recibo
            const receiptHtml = generateReceiptContent({...saleData, id: newSaleRef.id});
            showReceiptModal(receiptHtml);

            state.cart = []; // Vacía el carrito después de la venta
            state.searchTerm = ''; // Limpia el término de búsqueda
            state.amountReceived = 0; // Reinicia el monto recibido
            state.currentSaleCustomerId = 'general'; // Reinicia la selección del cliente

            await fetchData('productos'); // Actualiza el stock
            await fetchData('ventas'); // Agrega la nueva venta
            await fetchData('clientes'); // Actualiza el total de compras del cliente
            
            renderNuevaVentaStructure(); // Al procesar la venta, vuelve a renderizar la estructura y luego sus contenidos
            document.getElementById('product-search').value = ''; // Y asegúrate de que el input de búsqueda no tenga el valor anterior
            renderDashboard(); // Actualiza el dashboard también
            renderVentas(); // Actualiza el historial de ventas
        } catch (e) {
            console.error("Error al procesar la venta: ", e);
            alert('Hubo un error al procesar la venta.');
        }
    };

    // --- NUEVAS FUNCIONES PARA EL RECIBO ---

    function generateReceiptContent(saleData) {
        // NUEVA FUNCIONALIDAD: Usar datos del negocio desde el estado
        const empresaNombre = state.businessInfo.nombre || "Distribuidora Chacha";
        const direccion = state.businessInfo.direccion || "Tu Dirección, Ciudad, País";
        const telefono = state.businessInfo.telefono || "123-456-7890";
        const ruc = state.businessInfo.ruc || "0000000000001"; // RUC o Identificación fiscal

        const saleDateTime = saleData.fechaLocal ? new Date(saleData.fechaLocal).toLocaleString('es-ES', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : new Date().toLocaleString('es-ES');
        const saleId = saleData.id ? saleData.id.substring(0, 12) : 'N/A'; // Usar los primeros 12 caracteres del ID para el recibo

        let itemsHtml = saleData.items.map(item => `
            <div class="flex justify-between receipt-item">
                <span style="flex: 1; text-align: left;">${item.cantidad} x ${item.nombre}</span>
                <span style="width: 50px; text-align: right;">$${item.precioUnitario.toFixed(2)}</span>
                <span style="width: 60px; text-align: right; font-weight: bold;">$${(item.cantidad * item.precioUnitario).toFixed(2)}</span>
            </div>
        `).join('');

        return `
            <div id="receipt-print-area" class="text-xs p-4" style="max-width: 500px; margin: 0 auto; line-height: 1.2;">
                <h4 class="text-center font-bold text-base mb-1">${empresaNombre}</h4>
                <p class="text-center">${direccion}</p>
                <p class="text-center">Tel: ${telefono}</p>
                <p class="text-center">RUC: ${ruc}</p>
                <p class="text-center mt-2 border-t border-b border-dashed py-1">--- RECIBO DE VENTA ---</p>
                
                <p class="mt-2"><strong>ID Venta:</strong> #${saleId}</p>
                <p><strong>Fecha:</strong> ${saleDateTime}</p>
                <p><strong>Cliente:</strong> ${saleData.clienteNombre}</p>
                ${saleData.clienteCedula && saleData.clienteCedula !== 'N/A' ? `<p><strong>C.I./RUC:</strong> ${saleData.clienteCedula}</p>` : ''}
                ${saleData.clienteTelefono && saleData.clienteTelefono !== 'N/A' ? `<p><strong>Teléfono:</strong> ${saleData.clienteTelefono}</p>` : ''}
                ${saleData.clienteCelular && saleData.clienteCelular !== 'N/A' ? `<p><strong>Celular:</strong> ${saleData.clienteCelular}</p>` : ''}

                <div class="mt-4 border-t border-dashed pt-2">
                    <div class="flex justify-between font-bold">
                        <span style="flex: 1; text-align: left;">Artículo</span>
                        <span style="width: 50px; text-align: right;">P.U.</span>
                        <span style="width: 60px; text-align: right;">Total</span>
                    </div>
                    ${itemsHtml}
                </div>
                
                <div class="border-t border-dashed pt-2 mt-2 receipt-total">
                    <div class="flex justify-between font-bold text-sm">
                        <span>Subtotal:</span>
                        <span>$${saleData.subtotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between font-bold text-sm">
                        <span>IVA (0%):</span>
                        <span>$0.00</span>
                    </div>
                    <div class="flex justify-between font-bold text-base mt-1">
                        <span>TOTAL:</span>
                        <span>$${saleData.total.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-sm mt-1">
                        <span>Monto Recibido:</span>
                        <span>$${saleData.montoRecibido.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-sm font-bold">
                        <span>Cambio:</span>
                        <span>$${saleData.cambio.toFixed(2)}</span>
                    </div>
                </div>
                
                <p class="text-center mt-4 pt-2 border-t border-dashed">¡Gracias por su compra!</p>
                <p class="text-center text-xs">Visítanos de nuevo</p>
            </div>
        `;
    }

    function showReceiptModal(receiptHtml) {
        const modalContent = `
            <h3 class="text-xl font-semibold mb-4 no-print">Recibo de Venta Generado</h3>
            <div class="receipt-preview-container border p-2 rounded max-h-96-overflow bg-gray-50">
                ${receiptHtml}
            </div>
            <div class="mt-6 text-right no-print">
                <button onclick="printReceipt()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2">
                    <i class="fas fa-print mr-2"></i> Imprimir Recibo
                </button>
                <button onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
        `;
        window.showModal(modalContent);
    }

    window.printReceipt = () => {
        // Dispara la función de impresión del navegador
        window.print();
    };


    window.viewSaleDetails = (saleId) => {
        const sale = state.ventas.find(s => s.id === saleId);
        if (!sale) {
            alert('Detalles de venta no encontrados. Asegúrate de que los datos de ventas estén cargados.');
            console.error('Venta no encontrada para ID:', saleId);
            return;
        }

        const saleDate = sale.fecha ? new Date(sale.fecha.toDate()).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';

        let itemsHtml = sale.items.map(item => `
            <div class="flex justify-between border-b pb-1 mb-1 text-sm">
                <span>${item.cantidad} x ${item.nombre}</span>
                <span>$${(item.cantidad * item.precioUnitario).toFixed(2)}</span>
            </div>
        `).join('');

        const modalContent = `
            <h3 class="text-xl font-semibold mb-4">Detalles de Venta #${sale.id.substring(0, 8)}...</h3>
            <div class="space-y-2 text-gray-700">
                <p><strong>Fecha:</strong> ${saleDate}</p>
                <p><strong>Cliente:</strong> ${sale.clienteNombre || 'Cliente General'}</p>
                ${sale.clienteCedula && sale.clienteCedula !== 'N/A' ? `<p><strong>C.I./RUC:</strong> ${sale.clienteCedula}</p>` : ''}
                ${sale.clienteTelefono && sale.clienteTelefono !== 'N/A' ? `<p><strong>Teléfono:</strong> ${sale.clienteTelefono}</p>` : ''}
                ${sale.clienteCelular && sale.clienteCelular !== 'N/A' ? `<p><strong>Celular:</strong> ${sale.clienteCelular}</p>` : ''}

                <p><strong>Método de Pago:</strong> ${sale.metodoPago}</p>
                <p><strong>Estado:</strong> <span class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs">${sale.estado}</span></p>
                <div class="mt-4 pt-2 border-t">
                    <h4 class="font-semibold text-lg mb-2">Productos:</h4>
                    ${itemsHtml}
                </div>
                <div class="border-t pt-2 mt-4 space-y-1">
                    <div class="flex justify-between text-md">
                        <span>Subtotal:</span>
                        <span>$${sale.subtotal ? sale.subtotal.toFixed(2) : '0.00'}</span>
                    </div>
                    <div class="flex justify-between text-xl font-bold text-blue-600">
                        <span>Total:</span>
                        <span>$${sale.total ? sale.total.toFixed(2) : '0.00'}</span>
                    </div>
                    ${sale.montoRecibido !== undefined ? `
                    <div class="flex justify-between text-md">
                        <span>Monto Recibido:</span>
                        <span>$${sale.montoRecibido.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-md font-bold text-green-600">
                        <span>Cambio:</span>
                        <span>$${sale.cambio.toFixed(2)}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
        window.showModal(modalContent);
    };

    // Nueva función para eliminar una venta
    window.deleteSale = async (saleId) => {
        if (!confirm('¿Estás seguro de que quieres eliminar esta venta? Esta acción no se puede deshacer y el stock de los productos no será restaurado automáticamente.')) {
            return;
        }

        try {
            // No se restaurará el stock de productos, solo se elimina el registro de venta.
            await deleteDoc(doc(db, "ventas", saleId));
            await fetchData('ventas'); // Volver a cargar las ventas
            alert('Venta eliminada exitosamente.');
            renderVentas(); // Re-renderizar la sección de ventas
        } catch (error) {
            console.error("Error eliminando la venta: ", error);
            alert('Hubo un error al eliminar la venta.');
        }
    };

    // Funciones para Cuentas por Cobrar
    window.addCuentaPorCobrar = async (cuentaData) => {
        try {
            await addDoc(collection(db, "cuentas_por_cobrar"), {...cuentaData, fechaCreacion: serverTimestamp(), estado: 'Pendiente'});
            await fetchData('cuentas_por_cobrar');
            alert('Cuenta por cobrar añadida exitosamente!');
            renderCuentasPorCobrar();
        } catch (e) {
            console.error("Error añadiendo cuenta por cobrar: ", e);
            alert('Error añadiendo cuenta por cobrar.');
        }
    }

    window.updateCuentaPorCobrar = async (id, cuentaData) => {
        try {
            const cuentaRef = doc(db, "cuentas_por_cobrar", id);
            await updateDoc(cuentaRef, cuentaData);
            await fetchData('cuentas_por_cobrar');
            alert('Cuenta por cobrar actualizada exitosamente!');
            renderCuentasPorCobrar();
        } catch (e) {
            console.error("Error actualizando cuenta por cobrar: ", e);
            alert('Error actualizando cuenta por cobrar.');
        }
    }

    window.deleteCuentaPorCobrar = async (id) => {
        if (!confirm('¿Estás seguro de que quieres eliminar esta cuenta por cobrar?')) return;
        try {
            await deleteDoc(doc(db, "cuentas_por_cobrar", id));
            await fetchData('cuentas_por_cobrar');
            alert('Cuenta por cobrar eliminada exitosamente!');
            renderCuentasPorCobrar();
        } catch (e) {
            console.error("Error eliminando cuenta por cobrar: ", e);
            alert('Error eliminando cuenta por cobrar.');
        }
    }

    // Nueva función para marcar una cuenta por cobrar como pagada
    window.markCuentaAsPaid = async (id) => {
        if (!confirm('¿Estás seguro de que quieres marcar esta cuenta como "Pagada"?')) return;
        try {
            const cuentaRef = doc(db, "cuentas_por_cobrar", id);
            await updateDoc(cuentaRef, { estado: 'Pagada' });
            await fetchData('cuentas_por_cobrar');
            alert('Cuenta por cobrar marcada como pagada exitosamente!');
            renderCuentasPorCobrar();
        } catch (e) {
            console.error("Error al marcar cuenta como pagada: ", e);
            alert('Error al marcar cuenta como pagada.');
        }
    };

    window.showCuentaPorCobrarForm = (cuenta = null) => {
        const isEditing = cuenta !== null;
        const title = isEditing ? 'Editar Cuenta por Cobrar' : 'Nueva Cuenta por Cobrar';
        const submitText = isEditing ? 'Actualizar' : 'Guardar';
        const fechaVencimiento = cuenta && cuenta.fechaVencimiento ? new Date(cuenta.fechaVencimiento.toDate()).toISOString().split('T')[0] : '';

        const formHtml = `
            <h3 class="text-xl font-semibold mb-4">${title}</h3>
            <form id="cuenta-form" class="space-y-4">
                <div>
                    <label for="clienteId" class="block text-sm font-medium text-gray-700">Cliente</label>
                    <select id="clienteId" name="clienteId" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        <option value="">Seleccione un cliente</option>
                        ${state.clientes.map(client => `
                            <option value="${client.id}" ${cuenta && cuenta.clienteId === client.id ? 'selected' : ''}>${client.nombre}</option>
                        `).join('')}
                    </select>
                </div>
                <div>
                    <label for="monto" class="block text-sm font-medium text-gray-700">Monto</label>
                    <input type="number" id="monto" name="monto" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${cuenta ? cuenta.monto : ''}" required>
                </div>
                <div>
                    <label for="concepto" class="block text-sm font-medium text-gray-700">Concepto</label>
                    <input type="text" id="concepto" name="concepto" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${cuenta ? cuenta.concepto : ''}" required>
                </div>
                <div>
                    <label for="fechaVencimiento" class="block text-sm font-medium text-gray-700">Fecha de Vencimiento</label>
                    <input type="date" id="fechaVencimiento" name="fechaVencimiento" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${fechaVencimiento}" required>
                </div>
                ${isEditing ? `
                <div>
                    <label for="estado" class="block text-sm font-medium text-gray-700">Estado</label>
                    <select id="estado" name="estado" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                        <option value="Pendiente" ${cuenta.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                        <option value="Pagada" ${cuenta.estado === 'Pagada' ? 'selected' : ''}>Pagada</option>
                        <option value="Vencida" ${cuenta.estado === 'Vencida' ? 'selected' : ''}>Vencida</option>
                    </select>
                </div>
                ` : ''}
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">${submitText}</button>
                </div>
            </form>
        `;
        window.showModal(formHtml);

        document.getElementById('cuenta-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                clienteId: formData.get('clienteId'),
                monto: parseFloat(formData.get('monto')),
                concepto: formData.get('concepto'),
                fechaVencimiento: Timestamp.fromDate(new Date(formData.get('fechaVencimiento'))),
            };
            if (isEditing) {
                data.estado = formData.get('estado');
                await window.updateCuentaPorCobrar(cuenta.id, data);
            } else {
                await window.addCuentaPorCobrar(data);
            }
            window.hideModal();
        });
    }

    // --- FUNCIONES DE ESCÁNER DE CÓDIGO DE BARRAS ---
    let scannerQuagga = null;

    window.startScanner = () => {
        const scannerContainer = document.getElementById('barcode-scanner-container');
        const videoElement = document.getElementById('barcode-scanner-video');
        scannerContainer.style.display = 'block'; // Mostrar el contenedor del escáner
        state.isScannerActive = true;

        if (typeof Quagga === 'undefined') {
            console.error('QuaggaJS no está cargado. Asegúrate de incluir el script Quagga.js.');
            alert('Error: La funcionalidad de escáner no está disponible. Por favor, asegúrese de que QuaggaJS esté cargado.');
            scannerContainer.style.display = 'none';
            state.isScannerActive = false;
            return;
        }

        Quagga.init({
            inputStream : {
                name : "Live",
                type : "LiveStream",
                target: videoElement,
                constraints: {
                    width: 640,
                    height: 480,
                    facingMode: "environment" // Usa la cámara trasera si está disponible
                },
            },
            decoder : {
                readers : ["ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
            }
        }, function(err) {
            if (err) {
                console.error(err);
                alert('Error al iniciar el escáner: ' + err.message);
                scannerContainer.style.display = 'none';
                state.isScannerActive = false;
                return;
            }
            console.log("Initialization finished. Ready to start");
            Quagga.start();
            scannerQuagga = Quagga; // Guardar la instancia para poder detenerla
        });

        Quagga.onDetected(function(result) {
            const barcode = result.codeResult.code;
            console.log("Código de barras detectado:", barcode);
            
            const product = state.productos.find(p => p.barcode === barcode);
            if (product) {
                addToCart(product.id);
                // Detener el escáner automáticamente después de un escaneo exitoso
                stopScanner();
            } else {
                alert('Producto con código de barras "' + barcode + '" no encontrado.');
            }
            // Puedes limpiar el campo de búsqueda o hacer algo más con el código
            document.getElementById('product-search').value = barcode;
            // Asegúrate de que el input recupere el foco después de la detección
            document.getElementById('product-search').focus();
        });

        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay,
                drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.width), parseInt(drawingCanvas.height));
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                }

                if (result.codeResult && result.codeResult.code) {
                    Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: "red", lineWidth: 3});
                }
            }
        });
    };

    window.stopScanner = () => {
        if (scannerQuagga) {
            scannerQuagga.stop();
            console.log("Scanner stopped.");
            document.getElementById('barcode-scanner-container').style.display = 'none';
            state.isScannerActive = false;
            scannerQuagga = null; // Limpiar la referencia
            // Asegúrate de que el input recupere el foco al detener el escáner
            document.getElementById('product-search').focus();
        }
    };

    // --- FASE FINAL: INICIALIZACIÓN DE EVENTOS ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Cargar QuaggaJS dinámicamente si aún no está cargado
        if (typeof Quagga === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/quagga@0.12.1/dist/quagga.min.js';
            script.onload = () => {
                console.log('QuaggaJS cargado dinámicamente.');
            };
            document.head.appendChild(script);
        }

        DOMElements.sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.getAttribute('href').substring(1);
                window.showSection(sectionId);
            });
        });
        DOMElements.menuToggle.addEventListener('click', () => {
            DOMElements.sidebar.classList.toggle('-translate-x-full');
            DOMElements.overlay.classList.toggle('active');
        });
        DOMElements.overlay.addEventListener('click', () => {
            DOMElements.sidebar.classList.add('-translate-x-full');
            window.hideModal();
        });

        // Cargar datos iniciales y mostrar la sección de Dashboard al inicio
        await fetchData('productos');
        await fetchData('clientes');
        await fetchData('empleados');
        await fetchData('ventas');
        await fetchData('cuentas_por_cobrar');
        // NUEVA FUNCIONALIDAD: Cargar datos del negocio al iniciar
        await fetchBusinessInfo();
        window.showSection('dashboard-section');
    });
</script>

</body>
</html>
